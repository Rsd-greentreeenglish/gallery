<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>پنل مدیریت گالری (GitHub)</title>
  <style>
    body{font-family: Vazirmatn, sans-serif;background:#0f1724;color:#eef2ff;padding:18px}
    .card{background:#071027;padding:14px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;color:#9ca3af;margin-bottom:6px}
    input[type=text], input[type=password], input[type=number], textarea, select{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-bottom:8px
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:#0ea5a4;color:#042022}
    .btn-plain{background:#111827;color:#fff}
    .muted{color:#9ca3af}
    .list{margin-top:10px}
    .item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .thumb img{width:88px;height:64px;object-fit:cover;border-radius:6px}
    .actions{margin-left:auto;display:flex;gap:8px}
    .danger{background:#ef4444;color:white}
    .ok{background:#10b981;color:white}
    .info{background:#3b82f6;color:white}
    .notice{padding:8px;border-radius:8px;background:rgba(14,165,164,0.06);color:#bfeeea;margin-bottom:8px}
    .error{padding:8px;border-radius:8px;background:rgba(239,68,68,0.06);color:#fecaca;margin-bottom:8px}
    a.home{color:#a7f3d0;text-decoration:underline}
  </style>
</head>
<body>

<header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
  <div>
    <h2 style="margin:0">پنل مدیریت گالری (GitHub)</h2>
    <div class="muted">بدون فیلتر — داده‌ها در data.json مخزن GitHub شما ذخیره می‌شود</div>
  </div>
  <div><a class="home" href="index.html">نمایش گالری</a></div>
</header>

<section class="card">
  <h3>پیکربندی مخزن</h3>
  <label>مالک (Owner)</label>
  <input id="owner" value="rsd-greentreeenglish">

  <label>مخزن (Repo)</label>
  <input id="repo" value="gallery">

  <label>شاخه (Branch)</label>
  <input id="branch" value="main">

  <label>مسیر فایل داده (Path)</label>
  <input id="path" value="data.json">

  <label>توکن GitHub (Personal Access Token)</label>
  <input id="token" type="password" value="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">

  <div class="row" style="margin-top:8px">
    <button id="btnConnect" class="btn-primary">اتصال و بارگذاری data.json</button>
    <button id="btnGetRaw" class="btn-plain">گزینه: باز کردن در Raw</button>
  </div>

  <div id="status" style="margin-top:10px"></div>
</section>

<section class="card">
  <h3>افزودن تصویر جدید</h3>
  <label>لینک تصویر (URL یا مسیر در repo)</label>
  <input id="newUrl" placeholder="https://... یا images/your.jpg">
  <label>توضیحات</label>
  <input id="newDesc" placeholder="توضیح کوتاه">
  <div class="row">
    <button id="btnAdd" class="ok">افزودن به لیست (محلی)</button>
    <button id="btnPush" class="info">ذخیره در GitHub (commit)</button>
  </div>
  <div id="pushMsg" style="margin-top:8px"></div>
</section>

<section class="card">
  <h3>لیست تصاویر (بارگذاری شده از data.json)</h3>
  <div id="list" class="list"></div>
</section>

<!-- edit modal -->
<div id="editor" style="display:none;position:fixed;left:0;right:0;top:0;bottom:0;align-items:center;justify-content:center;background:rgba(2,6,23,0.6)">
  <div style="width:720px;max-width:96%;margin:auto;background:#071027;padding:16px;border-radius:10px">
    <h3>ویرایش تصویر</h3>
    <label>لینک</label>
    <input id="editUrl">
    <label>توضیح</label>
    <input id="editDesc">
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button onclick="closeEditor()" class="btn-plain">انصراف</button>
      <button id="applyEditBtn" class="ok">ذخیره محلی</button>
    </div>
  </div>
</div>

<script>
// state
let state = { owner:'rsd-greentreeenglish', repo:'gallery', branch:'main', path:'data.json', token:'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', sha:null, data:{ images: [] } };

// helper: show status
function setStatus(html, isError=false){
  const el = document.getElementById('status');
  el.innerHTML = `<div class="${isError?'error':'notice'}">${html}</div>`;
}

function toBase64(str){ return btoa(unescape(encodeURIComponent(str))); }
function fromBase64(b64){ try{ return decodeURIComponent(escape(atob(b64))); }catch(e){ return atob(b64); } }

async function loadRemote(){
  const url = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${encodeURIComponent(state.path)}?ref=${state.branch}`;
  setStatus('در حال خواندن data.json از GitHub ...');
  try{
    const headers = { 'Accept': 'application/vnd.github.v3+json', 'Authorization':'token ' + state.token };
    const res = await fetch(url, { headers });
    if(res.status === 404){
      state.sha = null;
      state.data = { images: [] };
      renderList();
      setStatus('فایل پیدا نشد؛ می‌توان آن را ایجاد کرد.');
      return;
    }
    if(!res.ok){ const txt=await res.text(); setStatus('خطا: '+res.status+' '+txt,true); return; }
    const json = await res.json();
    state.sha = json.sha;
    state.data = JSON.parse(fromBase64(json.content) || '{"images":[]}');
    renderList();
    setStatus('داده‌ها بارگذاری شد (sha: ' + state.sha + ')');
  }catch(err){ setStatus('خطای شبکه: '+err.message,true); }
}

function renderList(){
  const wrap = document.getElementById('list');
  wrap.innerHTML='';
  const arr = state.data.images||[];
  if(arr.length===0){ wrap.innerHTML='<div class="muted">هیچ تصویری وجود ندارد.</div>'; return; }
  arr.forEach((it,idx)=>{
    const id = idx+1;
    const node = document.createElement('div'); node.className='item';
    node.innerHTML = `
      <div class="thumb"><img src="${escapeHtml(it.url)}" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=120 height=90><rect width=100% height=100% fill=%23071020/></svg>'"></div>
      <div><div style="font-weight:700">#${id}</div><div class="muted" style="max-width:360px">${escapeHtml(it.desc||'')}</div></div>
      <div class="actions">
        <button class="btn-plain" onclick="openEditor(${idx})">ویرایش</button>
        <button class="danger" onclick="removeAt(${idx})">حذف</button>
      </div>`;
    wrap.appendChild(node);
  });
}

function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;'); }

document.getElementById('btnAdd').addEventListener('click', ()=>{
  const url = document.getElementById('newUrl').value.trim();
  const desc = document.getElementById('newDesc').value.trim();
  if(!url){ setStatus('لینک تصویر را وارد کن.', true); return; }
  state.data.images.push({ url, desc });
  renderList();
  setStatus('تصویر اضافه شد؛ برای ذخیره در GitHub روی "ذخیره در GitHub" کلیک کن.');
  document.getElementById('newUrl').value=''; document.getElementById('newDesc').value='';
});

document.getElementById('btnPush').addEventListener('click', async ()=>{
  const payload = JSON.stringify(state.data,null,2);
  const b64 = toBase64(payload);
  const url = `https://api.github.com/repos/${state.owner}/${state.repo}/contents/${encodeURIComponent(state.path)}`;
  const body = { message:'Update gallery (via admin panel)', content:b64, branch:state.branch };
  if(state.sha) body.sha = state.sha;
  setStatus('در حال ارسال به GitHub ...');
  try{
    const res = await fetch(url,{
      method:'PUT',
      headers:{'Accept':'application/vnd.github.v3+json','Authorization':'token '+state.token,'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const j = await res.json();
    if(!res.ok){ setStatus('خطا در آپلود: '+(j.message||res.status),true); return; }
    state.sha = j.content && j.content.sha;
    setStatus('ذخیره با موفقیت انجام شد. sha جدید: '+state.sha);
    document.getElementById('pushMsg').innerText='آخرین commit: '+(j.commit && j.commit.sha||'');
  }catch(err){ setStatus('خطای شبکه: '+err.message,true); }
});

function removeAt(idx){ if(!confirm('آیا مطمئنی حذف شود؟')) return; state.data.images.splice(idx,1); renderList(); setStatus('مورد حذف شد؛ برای ثبت در GitHub push کن.'); }
function openEditor(idx){ const it=state.data.images[idx]; if(!it) return; document.getElementById('editUrl').value=it.url||''; document.getElementById('editDesc').value=it.desc||''; document.getElementById('editor').style.display='flex'; document.getElementById('applyEditBtn').onclick=function(){ applyEdit(idx); }; }
function applyEdit(idx){ const url=document.getElementById('editUrl').value.trim(); const desc=document.getElementById('editDesc').value.trim(); if(!url){ setStatus('لینک را وارد کن.',true); return; } state.data.images[idx]={url,desc}; renderList(); closeEditor(); setStatus('ویرایش ذخیره شد؛ برای ثبت در GitHub push کن.'); }
function closeEditor(){ document.getElementById('editor').style.display='none'; }

document.getElementById('btnConnect').addEventListener('click', async ()=>{ await loadRemote(); });
document.getElementById('btnGetRaw').addEventListener('click', ()=>{ window.open(`https://raw.githubusercontent.com/${state.owner}/${state.repo}/${state.branch}/${state.path}`,'_blank'); });

// auto load on page load
loadRemote();
</script>
</body>
</html>
